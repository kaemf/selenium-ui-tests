# –¶–µ–π —Ñ–∞–π–ª –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–º—ñ—Å—Ç–∏—Ç–∏ –≤ –æ—Å–Ω–æ–≤–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:
# .github/workflows/main.yml

name: Main Project CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # JOB 1: –ó–±—ñ—Ä–∫–∞ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–¥—É
  build:
    name: Build Project
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üî® Build project
        run: npm run build

      - name: üíæ Cache build
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            dist
          key: ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json') }}

  # JOB 2: –ó–∞–ø—É—Å–∫ –ª—ñ–Ω—Ç–µ—Ä–∞
  lint:
    name: Run Linter
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üîç Run ESLint
        run: npm run lint

  # JOB 3: –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç—ñ–≤
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üß™ Run unit tests
        run: npm test

      - name: üìä Upload coverage
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests

  # JOB 4: –¢—Ä–∏–≥–µ—Ä UI-—Ç–µ—Å—Ç—ñ–≤ (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤—Å–µ –ø—Ä–æ–π—à–ª–æ —É—Å–ø—ñ—à–Ω–æ)
  trigger-ui-tests:
    name: Trigger UI Tests
    needs: [build, lint, test]
    runs-on: ubuntu-latest
    if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: üöÄ Trigger UI Tests Repository
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.UI_TESTS_REPO_TOKEN }}
          repository: ${{ github.repository_owner }}/selenium-ui-tests
          event-type: trigger-ui-tests
          client-payload: |
            {
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "branch": "${{ github.ref_name }}",
              "repository": "${{ github.repository }}",
              "actor": "${{ github.actor }}",
              "run_id": "${{ github.run_id }}"
            }

      - name: ‚úÖ Log trigger event
        run: |
          echo "‚úÖ Successfully triggered UI tests repository"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üåø Branch: ${{ github.ref_name }}"

  # JOB 5: –ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π –∑–≤—ñ—Ç
  report:
    name: Pipeline Summary
    needs: [build, lint, test, trigger-ui-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üìã Check overall status
        run: |
          echo "==================================================="
          echo "            Pipeline Execution Summary            "
          echo "==================================================="
          echo ""
          echo "Build:       ${{ needs.build.result }}"
          echo "Lint:        ${{ needs.lint.result }}"
          echo "Tests:       ${{ needs.test.result }}"
          echo "UI Trigger:  ${{ needs.trigger-ui-tests.result }}"
          echo ""
          echo "==================================================="
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–æ–º–∏–ª–∫–∏
          if [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "‚ùå Pipeline FAILED"
            exit 1
          else
            echo "‚úÖ Pipeline PASSED"
          fi

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.test.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const comment = `
            ## ${status} CI Pipeline Results
            
            | Job | Status |
            |-----|--------|
            | Build | ${{ needs.build.result }} |
            | Lint | ${{ needs.lint.result }} |
            | Tests | ${{ needs.test.result }} |
            | UI Tests Triggered | ${{ needs.trigger-ui-tests.result }} |
            
            **Commit:** \`${{ github.sha }}\`
            **Author:** @${{ github.actor }}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# –°–µ–∫—Ä–µ—Ç–∏ —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ –≤ GitHub Settings:
# 1. UI_TESTS_REPO_TOKEN - Personal Access Token –∑ –ø—Ä–∞–≤–∞–º–∏ repo —Ç–∞ workflow
#    –¥–ª—è —Ç—Ä–∏–≥–µ—Ä–∏–Ω–≥—É UI-—Ç–µ—Å—Ç—ñ–≤ –≤ —ñ–Ω—à–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó

